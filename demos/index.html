<html>
	<head>
		<title>SCEJS Draft</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<script src="../SCEJS/SCE.class.js"></script> 
		
		<script src="../SCEJS/Prefabs/SimpleCamera/SimpleCamera.class.js"></script>
		
		<script src="../SCEJS/Prefabs/SimpleNode/SimpleNode.class.js"></script>
		
		<script src="../SCEJS/Prefabs/Graph/KERNEL_DIR.class.js"></script>
		<script src="../SCEJS/Prefabs/Graph/KERNEL_POS_OPPOSITE.class.js"></script>
		<script src="../SCEJS/Prefabs/Graph/KERNEL_POSBYDIR.class.js"></script>
		<script src="../SCEJS/Prefabs/Graph/VFP_NODEPICKDRAG.class.js"></script>
		<script src="../SCEJS/Prefabs/Graph/VFP_NODE.class.js"></script>
		<script src="../SCEJS/Prefabs/Graph/Graph.class.js"></script>
		
		<script src="../SCEJS/Prefabs/Grid/VFP_GRID.class.js"></script>
		<script src="../SCEJS/Prefabs/Grid/Grid.class.js"></script>
	</head>
	
	<body>
		
		<div id="SCEJS"></div> 		
		<button id="BTNID_RD">random destination</button><br />
		<button id="BTNID_WH">widthheight destination</button><br />
		<button id="BTNID_DIR">direction destination</button><br />
		<button id="BTNID_SPHERICAL">spherical destination</button><br />
		<button id="BTNID_IMG">imagecolor nodeVertexCol</button><br />
		<img id="IMGID_lena" src="_RESOURCES/lena_128x128.jpg" /><br />
		
		<script>
			var sce = new SCE();
			sce.initialize({"target": document.getElementById("SCEJS"),
							"dimensions": {"width": 512, "height": 512}});
			
			
			var project = new Project();	
			sce.loadProject(project);
			
			var stage = new Stage();			
			project.addStage(stage);
			project.setActiveStage(stage);
			
			// CAMERA
			var simpleCamera = new SimpleCamera(sce);
						
			// NODE
			//var simpleNode = new SimpleNode(sce); 
			//simpleNode.setImage("../demos/_RESOURCES/cartman08.jpg");
			
			// GRID
			var grid = new Grid(sce);
			grid.generate(100.0, 1.0);
			
			
			// GRAPH
			var OFFSET = 1000.0;
			var offs = OFFSET/10;
			var numNodes = 50*50; 
			var numLinks = 1;
			
			var graph = new Graph(sce);			
			graph.setOffset(OFFSET);
			
			var mesh_nodes = new Mesh().loadTriangle();
			graph.setNodeMesh(mesh_nodes);
			
			graph.setFontsImage("../SCEJS/Prefabs/Graph/fonts.png");  
			/*graph.set_destinationWidthHeight({width:16,
												height:16,
												spacing:2.0});*/
			//graph.set_dir("random");
			graph.setSelfShadows(false);
			
			
			// SET APPLY THIS LAYOUT
			var arrPP = [];
			arrPP.push({"x": -(offs/2)+(Math.random()*offs), "y": -(offs/2)+(Math.random()*offs), "z": -(offs/2)+(Math.random()*offs),
						"polarity": 1.0,
						"orbit": 0.0,
						"force": 0.5});
			lines_argumentsPoles = (function(arrPP) {
				var str = '';
				for(var n = 0, f = arrPP.length; n < f; n++) {
					str += 'float pole'+n+'X,'+
							'float pole'+n+'Y,'+
							'float pole'+n+'Z,'+
							'float pole'+n+'Polarity,'+
							'float pole'+n+'Orbit,'+
							'float pole'+n+'Force,';
				}
				return str;
			}).bind(this);
			lines_poles = (function(arrPP) {
				var str = 'float offset;vec3 polePos;vec3 vecN; float toDir; vec3 cc;float distanceToPole;\n';
				for(var n = 0, f = arrPP.length; n < f; n++) {
					str += 'polePos = vec3(pole'+n+'X,pole'+n+'Y,pole'+n+'Z);\n'+ 
							'toDir = -1.0;\n'+  
							'if(sign(particlePolarity[x]) == 0.0 && sign(pole'+n+'Polarity) == 1.0) toDir = 1.0;\n'+
							'if(sign(particlePolarity[x]) == 1.0 && sign(pole'+n+'Polarity) == 0.0) toDir = 1.0;\n'+
							'offset = '+OFFSET.toFixed(20)+';'+
							
							'distanceToPole = 1.0-sqrt(length(vec3(polePos-currentPos)/offset));'+
							
							'vecN = ((vec3(polePos-currentPos)-(-1.0))/(1.0-(-1.0)) - 0.5 ) *2.0 * pole'+n+'Force * toDir;'+
							'cc = vecN*distanceToPole ;\n'+
							
							'currentDir = clamp(currentDir+(cc*0.001),-1.0,1.0);\n'+
							
							//'if(pole'+n+'Orbit == 1.0) cc = 
							'';
				}
				return str;
			}).bind(this);
			graph.applyLayout({	"argsDirection":
										// pp
										"float* particlePolarity,"+lines_argumentsPoles(arrPP)+
										// destination
										"float4* dest,float destinationForce,float enableDestination,"+
										// lifeDistance
										"float4* initPos,float4* initDir,float lifeDistance", 
								"codeDirection": // [x], vec3 currentDir, vec3 currentPos
									// pp
									lines_poles(arrPP)+
									// destination
									'if(enableDestination == 1.0) {\n'+
										'vec3 destinationPos = dest[x].xyz;\n'+ 
										'vec3 dirDestination = normalize(destinationPos-currentPos);\n'+
										'float distan = abs(distance(currentPos,destinationPos));\n'+
										'float dirDestWeight = sqrt(distan);\n'+  
										'currentDir = (currentDir+(dirDestination*dirDestWeight*destinationForce))*dirDestWeight*0.1;\n'+
									'}\n'+
									// lifeDistance
									'vec3 newPos = (currentPos+currentDir);\n'+
									'vec4 initPos = initPos[x];'+
									'if(lifeDistance > 0.0 && distance(vec3(initPos.x,initPos.y,initPos.z),newPos) > lifeDistance) {'+
										'vec4 initDir = vec4(initDir[x]);'+
										'currentDir = vec3(initDir.x,initDir.y,initDir.z);'+
									'}',
									
								"argsPosition":
									// lifeDistance
									"float4* initPos,float lifeDistance,"+
									// lock
									"float* nodeLock",
								"codePosition": // [x], vec3 currentPos, vec3 currentDir
									// lifeDistance
									'vec4 initPos = initPos[x];'+
									'if(lifeDistance > 0.0 && distance(vec3(initPos.x,initPos.y,initPos.z), currentPos) > lifeDistance)'+
										'currentPos = vec3(initPos.x,initPos.y,initPos.z);'+
									// lock
									'if(nodeLock[x] == 1.0)'+
										'currentDir = vec3(0.0, 0.0, 0.0);\n',
						
								"argsObject":
									// nodeColor
									"float4* nodeColor,"+
									// lock
									"float* nodeLock",
								"codeObject": // [x], vec4 nodeVertexColor, float isNode, float isLink, float isArrow, float isTarget, float isNodeText
									// nodeColor
									'if(isNode == 1.0) nodeVertexColor = nodeColor[x];'+
									'if((isLink == 1.0 || isArrow == 1.0) && isTarget == 1.0) nodeVertexColor = vec4(0.0, 1.0, 0.0, 1.0);'+
									'if((isLink == 1.0 || isArrow == 1.0) && isTarget == 0.0) nodeVertexColor = vec4(1.0, 0.0, 0.0, 1.0);'+
									// lock
									'if(nodeLock[x] == 1.0) nodeVertexColor *= vec4(0.8, 0.3, 0.3, 1.0);'+
									'if(nodeLock[x] == 0.0 && isNode == 1.0) nodeVertexPosition = vec4(nodeVertexPosition.x*3.0, nodeVertexPosition.y*3.0, nodeVertexPosition.z*3.0, 1.0);'+
									'gl_PointSize = 1.0;\n'}); 
			
			
			// SET LAYOUT GLOBAL ARGUMENTS DATA
			// pp
			for(var n = 0, f = arrPP.length; n < f; n++) {
				graph.setLayoutArgumentData({"argName": 'pole'+n+'X', "value": arrPP[n].x});
				graph.setLayoutArgumentData({"argName": 'pole'+n+'Y', "value": arrPP[n].y});
				graph.setLayoutArgumentData({"argName": 'pole'+n+'Z', "value": arrPP[n].z});
				graph.setLayoutArgumentData({"argName": 'pole'+n+'Polarity', "value": arrPP[n].polarity});
				graph.setLayoutArgumentData({"argName": 'pole'+n+'Orbit', "value": arrPP[n].orbit});
				graph.setLayoutArgumentData({"argName": 'pole'+n+'Force', "value": arrPP[n].force});
			}
			// destination
			graph.setLayoutArgumentData({"argName": "destinationForce", "value": 0.1});
			graph.setLayoutArgumentData({"argName": "enableDestination", "value": 1.0});			
			// lifeDistance
			graph.setLayoutArgumentData({"argName": "lifeDistance", "value": 0.0});
			
			
			
			// NODES AND LINKS CREATION
			for(var n=0; n < numNodes; n++) {
				var pos = [-(offs/2)+(Math.random()*offs), -(offs/2)+(Math.random()*offs), -(offs/2)+(Math.random()*offs), 1.0];
				
				var node = graph.addNode({
					"name": "#"+n.toString()+":"+n.toString(),
					"data": "#"+n.toString()+":"+n.toString(),
					"position": pos,
					"color": ((n % 2) ? "../SCEJS/Prefabs/Graph/lena.jpg" : "../SCEJS/Prefabs/Graph/cartman08.jpg"),
					"layoutNodeArgumentData": {	// pp
												"particlePolarity": 0.0,
												// destination
												"dest": [0.0, 0.0, 0.0, 0.0],
												// lifeDistance
												"initPos": pos, "initDir": [0.0, 0.0, 0.0, 0.0],
												// nodeColor
												"nodeColor": [Math.random(), Math.random(), Math.random(), 1.0],
												// lock
												"nodeLock": 0.0}, 
					"onmouseup": (function(nodeData) {
						
				}).bind(this)});
			}
			graph.updateNodes();
			
			for(var n=0; n < numLinks; n++) {
				var A = parseInt(Math.random()*numNodes).toString();
				var B = parseInt(Math.random()*numNodes).toString();
				 
				graph.addLink({	"origin": "#"+A+":"+A,
								"target": "#"+B+":"+B,
								"directed": true});
			}
			graph.updateLinks();	
			
			// SET SOME LAYOUT NODE ARGUMENTS DATA
			graph.setLayoutNodeArgumentData({	"nodeName": "#0:0",
												"argName": "nodeLock",
												"value": 1.0});
			
			
			
			
			// BUTTONS UI
			var arrayGenerator = new ArrayGenerator();
			
			document.getElementById("BTNID_RD").addEventListener("click", (function() {				
				graph.setLayoutNodeArgumentArrayData({	"argName": "dest",
														"value": arrayGenerator.randomArray({	"count": numNodes,
																								"offset": offs,
																								"type": "float4"})
													});
			}).bind(this));
			document.getElementById("BTNID_WH").addEventListener("click", (function() {				
				graph.setLayoutNodeArgumentArrayData({	"argName": "dest",
														"value": arrayGenerator.widthHeightArray({	"count": numNodes,
																									"width": 128,
																									"height": 128,
																									"spacing": 3.0})
													});
			}).bind(this));
			document.getElementById("BTNID_DIR").addEventListener("click", (function() {				
				graph.setLayoutNodeArgumentArrayData({	"argName": "dest",
														"value": arrayGenerator.float4Array({	"count": numNodes,
																								"float4": [-1.0+(Math.random()*2.0), -1.0+(Math.random()*2.0), -1.0+(Math.random()*2.0), 1.0]})
													});
			}).bind(this));
			
			document.getElementById("BTNID_SPHERICAL").addEventListener("click", (function() {				
				graph.setLayoutNodeArgumentArrayData({	"argName": "dest",
														"value": arrayGenerator.sphericalArray({"count": numNodes,
																								"radius": 10.0})
													});
			}).bind(this));
			
			document.getElementById("BTNID_IMG").addEventListener("click", (function() {				
				graph.setLayoutNodeArgumentArrayData({	"argName": "nodeColor",
														"value": arrayGenerator.imageArray({"count": numNodes,
																							"image": document.getElementById("IMGID_lena")})
													});
			}).bind(this));
			
			//*********
			// RENDER STAGE
			//*********
			project.getActiveStage().render();
			
			
			window.onresize = (function() {
				//sce.setDimensions(512, 128);
		    }).bind(this);
		</script>
		
	</body>
</html>
