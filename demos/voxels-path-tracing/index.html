<html>
	<head>
		<title>SCEJS Voxel Path Tracing</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
    
		<script src="../../SCEJS/SCE.class.js"></script>

		<script src="../../SCEJS/Prefabs/SimpleCamera/SimpleCamera.class.js"></script>

	    <script src="../../SCEJS/Prefabs/Grid/VFP_GRID.class.js"></script>
	    <script src="../../SCEJS/Prefabs/Grid/Grid.class.js"></script>
	
	
	    <script src="../../SCEJS/Prefabs/Voxelizator/VFP_Voxelizator.class.js"></script>
	    <script src="../../SCEJS/Prefabs/Voxelizator/Voxelizator.class.js"></script>
	    
	    <script src="../../SCEJS/Prefabs/GI/VFP_GI.class.js"></script>
	    <script src="../../SCEJS/Prefabs/GI/SE_GI.class.js"></script>
	    <script src="../../SCEJS/Prefabs/GI/GI.class.js"></script>
	    
	    <script src="../../SCEJS/Prefabs/VolumeView/SE_VolumeView.class.js"></script>	    
	</head>

	<body>
		<div id="SCEJS"></div>

		<button id="BTNID_makeVoxels">voxelizate & make path tracing</button><br />
		
		<script>
			var sce = new SCE();
			sce.initialize({"target": document.getElementById("SCEJS"),
							"dimensions": {"width": 512, "height": 512}});


			var project = new Project();
			sce.loadProject(project);

			var stage = new Stage();
			project.addStage(stage);
			project.setActiveStage(stage);

			// CAMERA
			var simpleCamera = new SimpleCamera(sce, {	"onmousedown": (function() {
															if(gi.isRunned() == true) {
																gi.stop();
															}
														}).bind(this), "onmouseup": (function() {
															if(gi.isRunned() == true) {
																gi.resume();
															}
														}).bind(this)});

			// GRID
			var grid = new Grid(sce);
			grid.generate(100.0, 1.0);


			// VOXELIZATOR & GI PREFABS
			var _gridSize = 5.1, _resolution = 128; 
			var OFFSET = 1000.0;
			
			var voxelizator = new Voxelizator(sce);
			var gi = new GI(sce);
			gi.setResolution(_resolution);
			gi.setGridSize(_gridSize);			
			
			var mesh = new Mesh().loadObj("../_RESOURCES/cornellBox3wall.obj", (function(mesh, textures) {
				voxelizator.setMesh(mesh);
				voxelizator.setImage("../_RESOURCES/white.jpg"); 
				
				gi.setMesh(mesh);
				gi.setImage("../_RESOURCES/white.jpg"); 				
			}).bind(this));
			





			//*********
			// RENDER STAGE
			//*********
			project.getActiveStage().render();


			window.onresize = (function() {
				//sce.setDimensions(512, 128);
		    }).bind(this);
			
 
			document.getElementById("BTNID_makeVoxels").addEventListener("click", (function() {
				voxelizator.generate({	"size": _gridSize,
										"resolution": _resolution,
										"fillmode": ["albedo","positionX","positionY","positionZ","normal"],
										"ongenerate": function() {
											var images = voxelizator.getGeneratedImages();
											for(var key in images) {
												document.body.appendChild(images[key]);
											}
											
											gi.setVoxelsArrays(voxelizator.getGeneratedArrays());											
											gi.runGI();
											
											
											
											var comp_screenEffects = project.getActiveStage().getActiveCamera().getComponent(Constants.COMPONENT_TYPES.SCREEN_EFFECTS);
											comp_screenEffects.addKernel({	"name": "sampler_volume",
																			"kernel": new SE_VolumeView(_resolution),			
																			"width": sce.getCanvas().width, 
																			"height": sce.getCanvas().height,
																			"enableDepthTest": false,
																			"enableBlend": false, 
																			"blendSrc": Constants.BLENDING_MODES.ONE_MINUS_DST_ALPHA,
																			"blendDst": Constants.BLENDING_MODES.SRC_COLOR,
																			"onPostTick": (function() {						
																				
																			}).bind(this)});
											console.log(voxelizator.getGeneratedArrays().normal);
											comp_screenEffects.setArg("sampler_volume", (function(){return voxelizator.getGeneratedArrays().normal;}).bind(this));
											//comp_screenEffects.clearArg("sampler_volume", [1.0, 1.0, 1.0, 1.0]); 
											
											var comp_cam_tranf_target = project.getActiveStage().getActiveCamera().getComponent(Constants.COMPONENT_TYPES.TRANSFORM_TARGET);
											comp_screenEffects.setArg("posCamGoal", (function(){return [comp_cam_tranf_target.getPositionGoal().e[0], comp_cam_tranf_target.getPositionGoal().e[1], comp_cam_tranf_target.getPositionGoal().e[2], 1.0];}).bind(this));
											comp_screenEffects.setArgUpdatable("posCamGoal", true);
											
											comp_screenEffects.setArg("posCamTarget", (function(){return [comp_cam_tranf_target.getPositionTarget().e[0], comp_cam_tranf_target.getPositionTarget().e[1], comp_cam_tranf_target.getPositionTarget().e[2], 1.0];}).bind(this));
											comp_screenEffects.setArgUpdatable("posCamTarget", true);
											
											comp_screenEffects.setArg("viewportWidth", (function(){return sce.getCanvas().width;}).bind(this));
											comp_screenEffects.setArg("viewportHeight", (function(){return sce.getCanvas().height;}).bind(this));
											
											comp_screenEffects.setArg("uGridsize", (function(){return _gridSize;}).bind(this));
											comp_screenEffects.setArg("uResolution", (function(){return _resolution;}).bind(this));
										}
									});
			}).bind(this));
		</script>

	</body>
</html>
