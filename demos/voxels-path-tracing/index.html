<html>
	<head>
		<title>SCEJS Voxel Path Tracing</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
    
		<script src="../../SCEJS/SCE.class.js"></script>

		<script src="../../SCEJS/Prefabs/SimpleCamera/SimpleCamera.class.js"></script>

	    <script src="../../SCEJS/Prefabs/Grid/VFP_GRID.class.js"></script>
	    <script src="../../SCEJS/Prefabs/Grid/Grid.class.js"></script>
	
	
	    <script src="../../SCEJS/Prefabs/Voxelizator/VFP_VOXELIZATOR.class.js"></script>
	    <script src="../../SCEJS/Prefabs/Voxelizator/Voxelizator.class.js"></script>
	    
	    <script src="../../SCEJS/Prefabs/GI/VFP_GI.class.js"></script>
	    <script src="../../SCEJS/Prefabs/GI/GI.class.js"></script>
	    
	    <script src="../../SCEJS/Prefabs/VolumeView/SE_VolumeView.class.js"></script>	 


<style>
	input[type=range] {
 		-webkit-appearance: none; /* Hides the slider so that custom slider can be made */
 		width: 100%; /* Specific width is required for Firefox. */
   		border-radius: 2px;
	    height: 4px;
	    border: 1px solid #bdc3c7;
	    background-color: #fff; 
	}
	input[type=range]:focus {
	  outline: none;
	}
	/*input[type=range]::-webkit-slider-thumb {
	  -webkit-appearance: none;
	}
	input[type=range]::-ms-track {
	  width: 100%;
	  cursor: pointer;
	  background: transparent;
	  border-color: transparent;
	  color: transparent;
	}*/
</style>  
	</head>

	<body>
		<div id="SCEJS"></div>

		<script>
			var initializeVolumeView = (function() {
				comp_screenEffects.addKernel({	"name": "sampler_volume",
												"kernel": new SE_VolumeView(_resolution),			
												"width": sce.getCanvas().width, 
												"height": sce.getCanvas().height,
												"enableDepthTest": false,
												"enableBlend": false, 
												"blendSrc": Constants.BLENDING_MODES.ONE_MINUS_DST_ALPHA,
												"blendDst": Constants.BLENDING_MODES.SRC_COLOR,
												"onPostTick": (function() {						
													
												}).bind(this)});
				
				
				var comp_cam_tranf_target = project.getActiveStage().getActiveCamera().getComponent(Constants.COMPONENT_TYPES.TRANSFORM_TARGET);
				comp_screenEffects.setArg("posCamGoal", (function(){return [comp_cam_tranf_target.getPositionGoal().e[0], comp_cam_tranf_target.getPositionGoal().e[1], comp_cam_tranf_target.getPositionGoal().e[2], 1.0];}).bind(this));
				comp_screenEffects.setArgUpdatable("posCamGoal", true);
				
				comp_screenEffects.setArg("posCamTarget", (function(){return [comp_cam_tranf_target.getPositionTarget().e[0], comp_cam_tranf_target.getPositionTarget().e[1], comp_cam_tranf_target.getPositionTarget().e[2], 1.0];}).bind(this));
				comp_screenEffects.setArgUpdatable("posCamTarget", true);
				
				comp_screenEffects.setArg("viewportWidth", (function(){return sce.getCanvas().width;}).bind(this));
				comp_screenEffects.setArg("viewportHeight", (function(){return sce.getCanvas().height;}).bind(this));
			}).bind(this);
			
			var setVolumeView_samplers = (function(albedo, position, normal) {
				comp_screenEffects.setArg("sampler_voxelColor", (function(){return albedo;}).bind(this));
				comp_screenEffects.setArg("sampler_voxelPos", (function(){return position;}).bind(this));
				comp_screenEffects.setArg("sampler_voxelNormal", (function(){return normal;}).bind(this));
				
				comp_screenEffects.setArg("uGridsize", (function(){return _gridSize;}).bind(this));
				comp_screenEffects.setArg("uResolution", (function(){return _resolution;}).bind(this));
			}).bind(this);
		
			
		
			var sce = new SCE();
			sce.initialize({"target": document.getElementById("SCEJS"),
							"dimensions": {"width": 512, "height": 512}});


			var project = new Project();
			sce.loadProject(project);

			var stage = new Stage();
			project.addStage(stage);
			project.setActiveStage(stage);

			// CAMERA
			var simpleCamera = new SimpleCamera(sce, {	"onmousedown": (function() {
															if(gi.isRunned() == true) {
																//gi.stop();
															}
														}).bind(this), "onmouseup": (function() {
															if(gi.isRunned() == true) {
																gi.resume();
															}
														}).bind(this), "onmousemove": (function() {
                                                            if(gi.isRunned() == true) {
                                                                gi.resume();
                                                            }
                                                        }).bind(this)});
			var comp_screenEffects = project.getActiveStage().getActiveCamera().getComponent(Constants.COMPONENT_TYPES.SCREEN_EFFECTS);
			
			// GRID
			var grid = new Grid(sce);
			grid.generate(100.0, 1.0);


			// GI
			var _gridSize = 9.1, _resolution = 128; 
			var OFFSET = 1000.0;
						
			var gi = new GI(sce);
			gi.setResolution(_resolution);
			gi.setGridSize(_gridSize);
			
			var voxelizator = new Voxelizator(sce);
			
			var _mesh;
			var loadObj = (function(url, onload) {
				if(gi.isRunned() == true) gi.stop();
				new Mesh().loadObj(url, (function(onload, mesh, textures) {
					_mesh = mesh;
					
					gi.setMesh(_mesh);
					gi.setImage("../_RESOURCES/UV.jpg");
					
					voxelizator.setMesh(_mesh);  
					voxelizator.setImage("../_RESOURCES/UV.jpg");
					
					if(onload != undefined) onload();
				}).bind(this, onload));
			}).bind(this);
			loadObj("../_RESOURCES/testGI.obj");
			
			var _viewVolume = false;
			//initializeVolumeView();
			//comp_screenEffects.disableKernel("sampler_volume");


			//*********
			// RENDER STAGE
			//*********
			project.getActiveStage().render();

			

			window.onresize = (function() {
				//sce.setDimensions(512, 128);
		    }).bind(this);			
		</script>


		<div style="font-size:11px">
			T for top view<br />
			Alt+LeftMouse for Orbit<br />
			Alt+MiddleMouse for Pan<br />		
			P for perspective view<br />
			WASD for to move
		</div>
		<br />
		
		
		Load object: <select id="select_obj">
			<option>testGI.obj</option>
			<option>cornellBox3wall.obj</option>
			<option>marquesadoExt.obj</option>
			<option>sponza.obj</option>
		</select><br /><br />
		
		<div id="DIVID_sliderGridSize"></div>
		<div id="DIVID_sliderResolution"></div>
		
		<button id="BTNID_makeVoxels">voxelizate & make path tracing</button>
		<!-- <button id="BTNID_loadimage">load image & make path tracing</button><br /> 
		<img id="img_albedo" src="../_RESOURCES/cornellbox_albedo.png" />
		<img id="img_position" src="../_RESOURCES/cornellbox_position.png" />
		<img id="img_normal" src="../_RESOURCES/cornellbox_normal.png" />-->
		
		<div id="DIVID_checkboxViewVolume"></div>
				
		<div id="DIVID_status" style="font-size:16px;font-weight:bold"></div>
		
		<script>
			var _status = document.getElementById("DIVID_status");
			
			
			// SELECT OBJ
			var select = document.getElementById("select_obj");
			select.addEventListener("change", (function() {
				_status.innerHTML = "Loading obj...";
				
				loadObj("../_RESOURCES/"+select.options[select.selectedIndex].value, (function() {
					_status.innerHTML = "";
					
					document.getElementById("INPUTID_GRID_SIZEX").disabled = false;					
					document.getElementById("INPUTID_GRID_SIZEX_slider").disabled = false;
					document.getElementById("DIVID_sliderGridSize").style.color = "rgba(0,0,0,1.0)";
					
					document.getElementById("INPUTID_GRID_RESOLUTIONX").disabled = false;					
					document.getElementById("INPUTID_GRID_RESOLUTIONX_slider").disabled = false;
					if(_resolution <= 128) {
						e.style.color = "green";
						document.getElementById("INPUTID_GRID_RESOLUTIONX_slider").style.backgroundColor = "green";
					} else if(_resolution <= 192) {
						e.style.color = "orange";
						document.getElementById("INPUTID_GRID_RESOLUTIONX_slider").style.backgroundColor = "orange";
					} else if(_resolution > 192) {
						e.style.color = "red";
						document.getElementById("INPUTID_GRID_RESOLUTIONX_slider").style.backgroundColor = "red";
					}
				}).bind(this));
			}).bind(this));
			
			
			// SLIDER GRID SIZE
			var e = document.getElementById("DIVID_sliderGridSize");
			new ActionHelpers().add_slider(e, "GRID_SIZE", _gridSize, 1, 200, 1, (function(value) {
				_gridSize = value;
			}).bind(this));
			document.getElementById("INPUTID_GRID_SIZEX").readOnly = true; 
			
			
			// SLIDER RESOLUTION
			var e = document.getElementById("DIVID_sliderResolution");
			new ActionHelpers().add_slider(e, "GRID_RESOLUTION", _resolution, 32, 256, 32, (function(e, value) {
				_resolution = value;
				
				if(_resolution <= 128) {
					e.style.color = "green";
					document.getElementById("INPUTID_GRID_RESOLUTIONX_slider").style.backgroundColor = "green";
				} else if(_resolution <= 192) {
					e.style.color = "orange";
					document.getElementById("INPUTID_GRID_RESOLUTIONX_slider").style.backgroundColor = "orange";
				} else if(_resolution > 192) {
					e.style.color = "red";
					document.getElementById("INPUTID_GRID_RESOLUTIONX_slider").style.backgroundColor = "red";
				}
			}).bind(this, e));
			document.getElementById("INPUTID_GRID_RESOLUTIONX").readOnly = true;
			e.style.color = "green";
			document.getElementById("INPUTID_GRID_RESOLUTIONX_slider").style.backgroundColor = "green";
			
			// BTN voxelizate & make path tracing
			document.getElementById("BTNID_makeVoxels").addEventListener("click", (function() {
				_status.innerHTML = "Voxelizating...";
				
				document.getElementById("INPUTID_GRID_SIZEX").disabled = true;
				document.getElementById("INPUTID_GRID_SIZEX_slider").disabled = true;
				document.getElementById("DIVID_sliderGridSize").style.color = "rgba(0,0,0,0.3)";
				
				document.getElementById("INPUTID_GRID_RESOLUTIONX").disabled = true;				
				document.getElementById("INPUTID_GRID_RESOLUTIONX_slider").disabled = true;
				document.getElementById("DIVID_sliderResolution").style.color = "rgba(0,0,0,0.3)";
				
				
				
				gi.setResolution(_resolution);
				gi.setGridSize(_gridSize);	
				gi.setMesh(_mesh);
				gi.setImage("../_RESOURCES/UV.jpg");
				
				voxelizator.generate({	"size": _gridSize,
										"resolution": _resolution,
										"fillmode": ["albedo","position","normal"],
										"ongenerate": function() {
											var images = voxelizator.getGeneratedImages();
											for(var key in images) {
												document.body.appendChild(images[key]);
											}
											
											// GI
											gi.setVoxelsArrays(voxelizator.getGeneratedArrays());											
											gi.runGI();
											
											// volume view
											//setVolumeView_samplers(voxelizator.getGeneratedArrays().albedo, voxelizator.getGeneratedArrays().position, voxelizator.getGeneratedArrays().normal);
											
											
											if(_viewVolume == true) {
												comp_screenEffects.enableKernel("sampler_volume");
											}

											_status.innerHTML = "";
											
											document.getElementById("INPUTID_View_generated_voxels").disabled = false;
											document.getElementById("DIVID_checkboxViewVolume").style.color = "rgba(0,0,0,1.0)";
										}
									});
			}).bind(this));
			
			
			// BTN LOAD FROM IMAGE
			/*document.getElementById("BTNID_loadimage").addEventListener("click", (function() {
				// GI
				gi.setVoxelsArrays({"albedo": document.getElementById("img_albedo"),
									"position": document.getElementById("img_position"),
									"normal": document.getElementById("img_normal")});											
				gi.runGI();
				
				// volume view
				setVolumeView_samplers(document.getElementById("img_albedo"), document.getElementById("img_position"), document.getElementById("img_normal"));
				
				if(_viewVolume == true) {
					comp_screenEffects.enableKernel("sampler_volume");
				}
			}).bind(this));*/
			
			
			// CHECKBOX VIEW VOLUME
			var e = document.getElementById("DIVID_checkboxViewVolume");
			new ActionHelpers().add_checkbox(e, "View_generated_voxels", false, (function() {
				_viewVolume = true;
				comp_screenEffects.enableKernel("sampler_volume");
			}).bind(this), (function() {
				_viewVolume = false;
				comp_screenEffects.disableKernel("sampler_volume");
			}).bind(this));
			document.getElementById("INPUTID_View_generated_voxels").disabled = true;
			document.getElementById("DIVID_checkboxViewVolume").style.color = "rgba(0,0,0,0.3)";
		</script>
	</body>
</html>
