<html>
	<head>
		<title>SCEJS Graph</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		
		<script src="../../SCEJS/SCE.class.js"></script>

		<script src="../../SCEJS/Prefabs/SimpleCamera/SimpleCamera.class.js"></script>

		<script src="../../SCEJS/Prefabs/Grid/VFP_GRID.class.js"></script>
		<script src="../../SCEJS/Prefabs/Grid/Grid.class.js"></script>

		<script src="../../SCEJS/Prefabs/Graph/Graph.class.js"></script>
	</head>

	<body>
		<div id="SCEJS"></div>

		<script>
			var sce = new SCE();
			sce.initialize({"target": document.getElementById("SCEJS"),
							"dimensions": {"width": 512, "height": 512}});


			var project = new Project();
			sce.loadProject(project);

			var stage = new Stage();
			project.addStage(stage);
			project.setActiveStage(stage);

			// CAMERA
			var simpleCamera = new SimpleCamera(sce);
			simpleCamera.setView(Constants.VIEW_TYPES.TOP);
			simpleCamera.setVelocity(1.0);
			sce.setDimensions(1024, 750);
			
			// GRID
			var grid = new Grid(sce);
			grid.generate(100.0, 1.0);


			// GRAPH
			var OFFSET = 1000.0;
			var offs = OFFSET/10;



			var graph = new Graph(sce);
			graph.setOffset(OFFSET);

			graph.setFontsImage("../../SCEJS/Prefabs/Graph/fonts.png");

            graph.setTimelineDatetimeRange({"initDatetime": "24-Nov-2000 17:57:35",
                                            "endDatetime": "24-Nov-2015 17:57:35"});
            var animationFrames = 5000;
            graph.setTimelineFramesLength(animationFrames);

			// APPLY THIS LAYOUT
			graph.applyLayout({	// DIRECTION
								// [x], [xx_opposite]
								// vec3 currentDir, vec3 currentDir_opposite, vec3 currentPos, vec3 currentPos_opposite
								// float isNode, float isLink, float isTarget,
								// float nodeId, float nodeId_opposite, linkId, linkId_opposite
								"argsDirection":
										// dir
										"float4* ndirect,float enableNDirect,"+
										// destination
										"float4* dest,float destinationForce,float enableDestination,"+
										// lifeDistance
										"float4* initPos,float4* initDir,float lifeDistance",
								"codeDirection":
									// destination
									'if(enableDestination == 1.0) {\n'+
										'vec3 destinationPos = dest[x].xyz;\n'+
										'vec3 dirDestination = normalize(destinationPos-currentPos);\n'+
										'float distan = abs(distance(currentPos,destinationPos));\n'+
										'float dirDestWeight = sqrt(distan);\n'+
										'currentDir = (currentDir+(dirDestination*dirDestWeight*destinationForce))*dirDestWeight*0.1;\n'+
									'}\n'+
									// dir
									"if(enableNDirect == 1.0) currentDir += (ndirect[x].xyz*0.0001);"+
									// lifeDistance
									'vec3 newPos = (currentPos+currentDir);\n'+
									'vec4 initPos = initPos[x];'+
									'if(lifeDistance > 0.0 && distance(vec3(initPos.x,initPos.y,initPos.z),newPos) > lifeDistance) {'+
										'vec4 initDir = vec4(initDir[x]);'+
										'currentDir = vec3(initDir.x,initDir.y,initDir.z);'+
									'}',

								// POSITION
								// [x], vec3 currentPos, vec3 currentDir
								"argsPosition":
									// lifeDistance
									"float4* initPos,float lifeDistance,"+
									// lock
									"float* nodeLock",
								"codePosition":
									// lifeDistance
									'vec4 initPos = initPos[x];'+
									'if(lifeDistance > 0.0 && distance(vec3(initPos.x,initPos.y,initPos.z), currentPos) > lifeDistance)'+
										'currentPos = vec3(initPos.x,initPos.y,initPos.z);'+
									// lock
									'if(nodeLock[x] == 1.0)'+
										'currentDir = vec3(0.0, 0.0, 0.0);\n',

								// OBJECT
								// [x], vec4 nodeVertexColor, vec4 nodeVertexPosition, vec4 XYZW_opposite
								// float isNode, float isLink, float isArrow, float isNodeText, float isTarget
								"argsObject":
									// nodeColor
									"float4* nodeColor,"+
									// selfShadows
									"float4 sunPos,float selfShadows,float4 ambientColor,"+
									// lock
									"float* nodeLock",
								"codeObject":
                                    // nodeColor
                                    'if(isNode == 1.0) nodeVertexColor = nodeColor[x];'+
                                    //'if(isLink == 1.0 && currentLineVertex == 1.0) nodeVertexColor = vec4(0.0, 1.0, 0.0, 1.0);'+  // this is isTarget for arrows

                                    'float degr = (currentLineVertex/vertexCount)/2.0;'+
                                    'if(isLink == 1.0) nodeVertexColor = vec4(0.5+degr, 0.5+degr, 0.5+degr, 1.0);'+ // this is isTarget for arrows
                                    'if(isArrow == 1.0 && currentLineVertex == vertexCount) nodeVertexColor = vec4(0.0, 1.0, 0.0, 1.0);'+  // this is isTarget for arrows
                                    'if(isArrow == 1.0 && currentLineVertex == 0.0) nodeVertexColor = vec4(1.0, 0.0, 0.0, 0.0);'+  // this is isTarget for arrows
                                    // selfShadows
                                    'vec3 lightDirection = normalize(sunPos.xyz * -1.0);\n'+
                                    'float lightWeighting = max(dot(normalize(vWNMatrix.xyz), -lightDirection)*-1.0, 0.0);\n'+
                                    'vec3 weightDiffuse = min(vec3(1.0,1.0,1.0),vec3(lightWeighting,lightWeighting,lightWeighting));\n'+
                                    'if(selfShadows == 1.0) nodeVertexColor = (vVertexColor*vec4(weightDiffuse,1.0))+(ambientColor*vVertexColor);\n'+
                                    // lock
                                    'if(nodeLock[x] == 1.0) nodeVertexColor *= vec4(0.8, 0.3, 0.3, 1.0);'+
                                    //'if(nodeLock[x] == 0.0 && isNode == 1.0) nodeVertexPosition = vec4(nodeVertexPosition.x*3.0, nodeVertexPosition.y*3.0, nodeVertexPosition.z*3.0, 1.0);'+
                                    'gl_PointSize = 10.0;\n'
                                });


			// SET LAYOUT GLOBAL ARGUMENTS DATA
			// destination
			graph.setLayoutArgumentData({"argName": "destinationForce", "value": 0.1});
			graph.setLayoutArgumentData({"argName": "enableDestination", "value": 0.0});
			// lifeDistance
			graph.setLayoutArgumentData({"argName": "lifeDistance", "value": 0.0});
			// selfShadows
			graph.setLayoutArgumentData({"argName": "sunPos", "value": [0.2, -0.5, 0.4, 1.0]});
			graph.setLayoutArgumentData({"argName": "selfShadows", "value": 0.0});
			graph.setLayoutArgumentData({"argName": "ambientColor", "value": [0.2, 0.2, 0.2, 1.0]});



			// NODES AND LINKS CREATION
			var numNodes = 1000;
			var numLinks = 1000;
			for(var n=0; n < numNodes; n++) {
				var pos = [-(offs/2)+(Math.random()*offs), -(offs/2)+(Math.random()*offs), -(offs/2)+(Math.random()*offs), 1.0];

				// calculate born/die timestamps
                var generateRandomBornAndDie = (function(animationFrames) {
                    var timeFrameIncrement = graph.getTimeFrameIncrement();

                    var bornDate = graph.getInitTimestamp()+(parseInt(Math.random()*Math.max(0, animationFrames-20))*timeFrameIncrement);
                    var dieDate;
                    while(true) {
                        dieDate = graph.getInitTimestamp()+(parseInt(Math.random()*animationFrames)*timeFrameIncrement);
                        if(dieDate > bornDate)
                            break;
                    }
                    //console.log(bornDate);
                    //console.log(dieDate);

                    return {bornDate: bornDate, dieDate: dieDate};
                }).bind(this);

                var bd = generateRandomBornAndDie(animationFrames);

				var node = graph.addNode({
					"name": "#"+n.toString()+":"+n.toString(),
					"data": "#"+n.toString()+":"+n.toString(),
					"position": pos,
					"color": ((n % 2) ? "../_RESOURCES/lena_128x128.jpg" : "../_RESOURCES/cartman08.jpg"),
                    "bornDate": bd.bornDate,
                    "dieDate": bd.dieDate,
					"layoutNodeArgumentData": {
												// dir
												"ndirect": [0.0, 0.0, 0.0, 1.0],
												// pp
												"particlePolarity": 0.0,
												// destination
												"dest": [0.0, 0.0, 0.0, 0.0],
												// lifeDistance
												"initPos": pos, "initDir": [0.0, 0.0, 0.0, 0.0],
												// nodeColor
												"nodeColor": [Math.random(), Math.random(), Math.random(), 1.0],
												// lock
												"nodeLock": 0.0},
					"onmouseup": (function(nodeData) {

				}).bind(this)});
			}
			graph.updateNodes();

			for(var n=0; n < numLinks; n++) {
				var A = parseInt(Math.random()*numNodes).toString();
				var B = parseInt(Math.random()*numNodes).toString();

				graph.addLink({	"origin": "#"+A+":"+A,
								"target": "#"+B+":"+B,
								"directed": true});
			}
			graph.updateLinks();
			
			/*graph.adjacencyMatrixToImage(function(im) {
				document.body.appendChild(im);
				im.style.border = "1px solid red";
			});*/

			// SET SOME LAYOUT NODE ARGUMENTS DATA
			/*graph.setLayoutNodeArgumentData({	"nodeName": "#0:0",
												"argName": "nodeLock",
												"value": 1.0});*/
												
			//*********
			// RENDER STAGE
			//*********
			project.getActiveStage().render(function() {

            });


			window.onresize = (function() {
				//sce.setDimensions(512, 128);
		    }).bind(this);
		</script>



		T for top view<br />
		Alt+LeftMouse for Orbit<br />
		Alt+MiddleMouse for Pan<br />		
		P for perspective view<br />
		WASD for to move<br />
		<button id="BTNID_FORCELAYOUT_ON">ForceLayout On</button><br />
		<button id="BTNID_FORCELAYOUT_OFF">ForceLayout Off</button><br />
		<br />
		<button id="BTNID_RD">random destination</button><br />
		<button id="BTNID_WH">widthheight destination</button><br />
		<button id="BTNID_SPHERICAL">spherical destination</button><br />
		<button id="BTNID_HEM">hemispherical destination</button><br />
		<button id="BTNID_DESTINATION_OFF">Destination Off</button><br />
        <br />
        <button id="BTNID_playTimeline">play</button><br />
        <button id="BTNID_pauseTimeline">pause</button><br />
		<br />
		<button id="BTNID_DIR">random direction</button><br />
		<button id="BTNID_DIRECTION_OFF">Direction Off</button><br />
		<br />
		<button id="BTNID_IMG">node per pixel color</button><br />
		<img id="IMGID_lena" src="../_RESOURCES/lena_128x128.jpg" /><br />
		<script>
			// BUTTONS UI
			var arrayGenerator = new ArrayGenerator();
												
												
												
			document.getElementById("BTNID_FORCELAYOUT_ON").addEventListener("click", (function() {
				graph.enableForceLayout();
			}).bind(this));
			document.getElementById("BTNID_FORCELAYOUT_OFF").addEventListener("click", (function() {
				graph.disableForceLayout();
			}).bind(this));



			document.getElementById("BTNID_RD").addEventListener("click", (function() {
				graph.setLayoutArgumentData({"argName": "enableDestination", "value": 1.0});
				graph.setLayoutNodeArgumentArrayData({	"argName": "dest",
														"value": arrayGenerator.randomArray({	"count": numNodes,
																								"offset": 100.0,
																								"type": "float4"})
													});
			}).bind(this));
			document.getElementById("BTNID_WH").addEventListener("click", (function() {
				graph.setLayoutArgumentData({"argName": "enableDestination", "value": 1.0});
				graph.setLayoutNodeArgumentArrayData({	"argName": "dest",
														"value": arrayGenerator.widthHeightArray({	"count": numNodes,
																									"width": 128,
																									"height": 128,
																									"spacing": 3.0})
													});
			}).bind(this));
			document.getElementById("BTNID_SPHERICAL").addEventListener("click", (function() {
				graph.setLayoutArgumentData({"argName": "enableDestination", "value": 1.0});
				graph.setLayoutNodeArgumentArrayData({	"argName": "dest",
														"value": arrayGenerator.sphericalArray({"count": numNodes,
																								"radius": 100.0})
													});
			}).bind(this));
			document.getElementById("BTNID_HEM").addEventListener("click", (function() {
				graph.setLayoutArgumentData({"argName": "enableDestination", "value": 1.0});
				graph.setLayoutNodeArgumentArrayData({	"argName": "dest",
														"value": arrayGenerator.hemArray({	"count": numNodes,
																							"radius": 100.0,
																							"normalVector": $V3([0.0, 1.0, 0.0]),
																							"degrees": 1.0})
													});
			}).bind(this));
			document.getElementById("BTNID_DESTINATION_OFF").addEventListener("click", (function() {
				graph.setLayoutArgumentData({"argName": "enableDestination", "value": 0.0});
			}).bind(this));


            document.getElementById("BTNID_playTimeline").addEventListener("click", (function() {
                graph.playTimeline();
            }).bind(this));

            document.getElementById("BTNID_pauseTimeline").addEventListener("click", (function() {
                graph.pauseTimeline();
            }).bind(this));


			document.getElementById("BTNID_DIR").addEventListener("click", (function() {
				graph.setLayoutArgumentData({"argName": "enableNDirect", "value": 1.0});
				graph.setLayoutNodeArgumentArrayData({	"argName": "ndirect",
														"value": arrayGenerator.randomArray({	"count": numNodes,
																								"offset": 100.0,
																								"type": "float4"})
													});
													setTimeout(function() {
														graph.setLayoutArgumentData({"argName": "enableNDirect", "value": 0.0});
													}, 100);
			}).bind(this));
			document.getElementById("BTNID_DIRECTION_OFF").addEventListener("click", (function() {
				graph.setLayoutArgumentData({"argName": "enableNDirect", "value": 0.0});
			}).bind(this));


			document.getElementById("BTNID_IMG").addEventListener("click", (function() {
				graph.setLayoutNodeArgumentArrayData({	"argName": "nodeColor",
														"value": arrayGenerator.imageArray({"count": numNodes,
																							"image": document.getElementById("IMGID_lena")})
													});
			}).bind(this));
		</script>

	</body>
</html>
